var F=(C,L,l)=>new Promise((h,c)=>{var b=w=>{try{v(l.next(w))}catch(g){c(g)}},k=w=>{try{v(l.throw(w))}catch(g){c(g)}},v=w=>w.done?h(w.value):Promise.resolve(w.value).then(b,k);v((l=l.apply(C,L)).next())});import{d as ae,r as y,k as te,o as le,w as re,f as V,g as R,A as m,h as I,m as ne,bE as A,C as B,B as D,z as _,bF as K,bB as oe,bC as se,cu as ie,c$ as p,n as O,_ as ue}from"./index-Dks_UUQM.js";const de={class:"mr-[10px]"},ce={key:1,class:"dtoobar absolute z-50 top-35 left-6 bg-white bg-opacity-90 p-2 rounded shadow-md flex flex-col gap-2",style:{background:"rgb(0 0 0 / 60%)"}},ve=ae({name:"DrawingTool",__name:"DrawingTool",props:{enableDrawing:Boolean,stageRef:Object,drawingLayerRef:Object},emits:["update:enableDrawing","clear-drawing","undo-drawing","delete-selected"],setup(C,{emit:L}){const l=C,h=L,c=y("#df4b26"),b=y(!1),k=y(""),v=y("free"),w=y(!1),g=y([]),r=y(null),i=y(null),S=y(!1);let T=!1,n=null,d=null;const z=[{value:"free",label:"自由"},{value:"line",label:"直线"},{value:"arrow",label:"箭头"},{value:"triangle",label:"三角形"},{value:"rect",label:"长方形"},{value:"circle",label:"圆形"},{value:"text",label:"文本"},{value:"select",label:"选择"}],x=[10,5],U=["#ff4500","#ff8c00","#ffd700","#90ee90","#00ced1","#1e90ff","#c71585","rgba(255, 69, 0, 0.68)","rgb(255, 120, 0)","hsv(51, 100, 98)","hsvl(120, 40, 94, 0.5)","hsl(181, 100%, 37%)","hsla(209, 100%, 56%, 0.73)","#c7158577"];te(()=>{const a=z.find(e=>e.value===v.value);return a?a.label:""});const j=()=>{const a=!l.enableDrawing;h("update:enableDrawing",a),w.value=a,a?E():(r.value&&(r.value.stroke(k.value),r.value.strokeWidth(3),r.value=null),i.value&&(i.value.destroy(),i.value=null),v.value="free")},H=a=>{r.value&&(r.value.stroke(k.value),r.value.strokeWidth(3),r.value=null),i.value&&i.value.nodes([]),v.value=a},q=()=>{l.drawingLayerRef&&(l.drawingLayerRef.getNode().destroyChildren(),l.drawingLayerRef.getNode().draw(),g.value=[],r.value=null),h("clear-drawing")},G=()=>{if(g.value.length===0)return;const a=g.value.pop();a&&l.drawingLayerRef&&(a.destroy(),l.drawingLayerRef.getNode().draw()),h("undo-drawing")},J=()=>{if(!r.value||!l.drawingLayerRef)return;const a=g.value.indexOf(r.value);a!==-1&&(g.value.splice(a,1),r.value.destroy(),r.value=null),i.value&&i.value.nodes([]),l.drawingLayerRef.getNode().draw(),h("delete-selected")},Q=a=>{g.value.push(a)},E=()=>{var e,t;i.value&&i.value.destroy();const a=new p.Transformer({rotateEnabled:!0,anchorSize:8,borderStroke:"#0099ff",anchorStroke:"#0099ff",anchorCornerRadius:4,boundBoxFunc:(o,s)=>s.width<10||s.height<10?o:s,ignoreStroke:!0});a.on("transformstart",()=>{S.value=!0}),a.on("transformend",()=>{var o,s;S.value=!1,(s=(o=l.drawingLayerRef)==null?void 0:o.getNode())==null||s.batchDraw()}),(t=(e=l.drawingLayerRef)==null?void 0:e.getNode())==null||t.add(a),i.value=a},P=a=>{if(!l.enableDrawing||!a||a._partialText!==void 0||S.value)return;let e=!1;g.value.forEach(t=>{a._id==t._id&&(e=!0)}),e&&(i.value||E(),r.value!==a&&(r.value&&(r.value.stroke(k.value),r.value.strokeWidth(3)),k.value=a.stroke(),a.stroke("#3a7bd5"),a.strokeWidth(4),r.value=a,setTimeout(()=>{var t,o;if(i.value&&a)try{i.value.nodes([a]),(o=(t=l.drawingLayerRef)==null?void 0:t.getNode())==null||o.batchDraw()}catch(s){console.error("Failed to attach transformer:",s)}},0)))},X=a=>{const e=a.target.getStage();if(!l.enableDrawing||!l.drawingLayerRef||!e||S.value)return;if(v.value==="select"&&a.target!==e){P(a.target);return}if(a.target===e&&(r.value&&(r.value.stroke(c.value),r.value.strokeWidth(3),r.value=null),i.value&&(i.value.nodes([]),l.drawingLayerRef.getNode().batchDraw())),r.value||v.value==="select")return;T=!0;const t=e.getPointerPosition();if(t){switch(d=t,v.value){case"free":n=new p.Line({stroke:c.value,strokeWidth:3,points:[t.x,t.y],tension:0,draggable:!0,dash:b.value?x:void 0,strokeScaleEnabled:!1});break;case"line":n=new p.Line({stroke:c.value,strokeWidth:3,points:[t.x,t.y,t.x,t.y],draggable:!0,dash:b.value?x:void 0,strokeScaleEnabled:!1});break;case"arrow":n=new p.Arrow({points:[t.x,t.y,t.x,t.y],fill:c.value,stroke:c.value,strokeWidth:3,pointerLength:10,pointerWidth:10,draggable:!0,dash:b.value?x:void 0,strokeScaleEnabled:!1});break;case"triangle":n=new p.Line({fill:"transparent",stroke:c.value,strokeWidth:3,points:[t.x,t.y,t.x,t.y],draggable:!0,closed:!0,dash:b.value?x:void 0,strokeScaleEnabled:!1});break;case"rect":n=new p.Rect({x:t.x,y:t.y,width:0,height:0,stroke:c.value,strokeWidth:3,draggable:!0,dash:b.value?x:void 0,strokeScaleEnabled:!1});break;case"circle":n=new p.Circle({x:t.x,y:t.y,radius:0,stroke:c.value,strokeWidth:3,draggable:!0,dash:b.value?x:void 0,strokeScaleEnabled:!1});break;case"text":let o=new p.Text({x:t.x,y:t.y,text:"输入文本",fontSize:30,fontFamily:"Calibri",fill:c.value,draggable:!0});o.on("dblclick dbltap",s=>{ee(o)}),n=o;break}n.on("click tap",o=>{v.value==="select"&&P(o.currentTarget)}),l.drawingLayerRef.getNode().add(n),Q(n)}},Y=a=>{if(!T||!l.enableDrawing||!n)return;const e=a.target.getStage().getPointerPosition();if(e){switch(v.value){case"free":const t=n.points().concat([e.x,e.y]);n.points(t);break;case"line":n.points([d.x,d.y,e.x,e.y]);break;case"arrow":n.points([d.x,d.y,e.x,e.y]);break;case"triangle":n.points([d.x,d.y,e.x+150,e.y+150,e.x+(e.x-d.x)/2,e.y+(e.y-d.y)/2]);break;case"rect":n.width(Math.abs(e.x-d.x)),n.height(Math.abs(e.y-d.y)),n.x(Math.min(d.x,e.x)),n.y(Math.min(d.y,e.y));break;case"circle":const o=e.x-d.x,s=e.y-d.y,f=Math.sqrt(o*o+s*s);n.radius(f);break}l.drawingLayerRef.getNode().batchDraw()}},Z=()=>{T=!1},M=y(!1),u=y(),W=y(),ee=a=>F(null,null,function*(){var f,N;M.value=!0,W.value=a,yield O();const e=(N=(f=l.stageRef)==null?void 0:f.getStage())==null?void 0:N.getContainer();if(!u.value||!e)return;const t=e.getBoundingClientRect(),o=a.getAbsolutePosition(),s=a.getClientRect();u.value.value=a.text(),u.value.style.position="absolute",u.value.style.top=`${t.top+o.y-227}px`,u.value.style.left=`${t.left+o.x-165}px`,u.value.style.width=`${s.width}px`,u.value.style.height=`${s.height}px`,u.value.style.fontSize=`${a.fontSize()}px`,u.value.style.display="block",u.value.style.zIndex="1000",u.value.focus(),u.value.select()}),$=()=>{!M.value||!u.value||!W.value||(W.value.text(u.value.value),u.value.style.display="none",M.value=!1)};return le(()=>{re(()=>l.enableDrawing,a=>{var t;const e=(t=l.stageRef)==null?void 0:t.getStage();e&&(a?(e.container().style.cursor="crosshair",e.on("mousedown touchstart",X),e.on("mousemove touchmove",Y),e.on("mouseup touchend mouseleave",Z),O(()=>{E()})):(e.container().style.cursor="default",e.off("mousedown touchstart"),e.off("mousemove touchmove"),e.off("mouseup touchend mouseleave"),i.value&&(i.value.destroy(),i.value=null)))},{immediate:!0})}),(a,e)=>{const t=B("el-color-picker"),o=B("el-switch"),s=B("el-button");return R(),V("div",null,[m(t,{modelValue:c.value,"onUpdate:modelValue":e[0]||(e[0]=f=>c.value=f),"show-alpha":!0,class:"mr-[10px]",predefine:U},null,8,["modelValue"]),I("span",de,[e[2]||(e[2]=D(" 虚框")),m(o,{modelValue:b.value,"onUpdate:modelValue":e[1]||(e[1]=f=>b.value=f)},null,8,["modelValue"])]),m(s,{type:l.enableDrawing?"primary":"",onClick:j},{default:_(()=>[D(K(l.enableDrawing?"退出绘图":"自由绘图"),1)]),_:1},8,["type"]),m(s,{type:"danger",disabled:!l.enableDrawing,onClick:q},{default:_(()=>e[3]||(e[3]=[D(" 清除绘图 ")])),_:1,__:[3]},8,["disabled"]),m(s,{type:"warning",disabled:!l.enableDrawing||g.value.length===0,onClick:G},{default:_(()=>e[4]||(e[4]=[D(" 撤销 ")])),_:1,__:[4]},8,["disabled"]),l.enableDrawing?(R(),ne(s,{key:0,type:"danger",disabled:!l.enableDrawing||!r.value,onClick:J},{default:_(()=>e[5]||(e[5]=[D(" 删除选中 ")])),_:1,__:[5]},8,["disabled"])):A("",!0),w.value?(R(),V("div",ce,[(R(),V(oe,null,se(z,f=>m(s,{key:f.value,size:"small",type:v.value===f.value?"primary":"",onClick:N=>H(f.value)},{default:_(()=>[D(K(f.label),1)]),_:2},1032,["type","onClick"])),64)),I("input",{ref_key:"inputRef",ref:u,type:"text",class:"text-input",style:{display:"none"},onBlur:$,onKeyup:ie($,["enter"])},null,544)])):A("",!0)])}}}),ye=ue(ve,[["__scopeId","data-v-a1562d4e"]]);export{ye as default};
