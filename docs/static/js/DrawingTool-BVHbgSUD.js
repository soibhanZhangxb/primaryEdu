import{d as j,r as f,k as A,o as H,w as I,f as x,g as k,A as h,m as $,bE as R,C as q,z as v,B as b,bF as S,bB as K,bC as U,c$ as g,n as G,_ as J}from"./index-BbWQ1fjE.js";const Q={key:1,class:"dtoobar absolute z-50 top-35 left-6 bg-white bg-opacity-90 p-2 rounded shadow-md flex flex-col gap-2",style:{background:"rgb(0 0 0 / 60%)"}},X=j({name:"DrawingTool",__name:"DrawingTool",props:{enableDrawing:Boolean,stageRef:Object,drawingLayerRef:Object},emits:["update:enableDrawing","clear-drawing","undo-drawing","delete-selected"],setup(C,{emit:N}){const r=C,w=N,d=f("free"),D=f(!1),c=f([]),n=f(null),l=f(null),y=f(!1);let p=!1,o=null,u=null;const _=[{value:"free",label:"自由"},{value:"line",label:"直线"},{value:"arrow",label:"箭头"},{value:"rect",label:"长方形"},{value:"circle",label:"圆形"},{value:"select",label:"选择"}];A(()=>{const a=_.find(e=>e.value===d.value);return a?a.label:""});const M=()=>{const a=!r.enableDrawing;w("update:enableDrawing",a),D.value=a,a?m():(n.value&&(n.value.stroke("#df4b26"),n.value.strokeWidth(3),n.value=null),l.value&&(l.value.destroy(),l.value=null),d.value="free")},T=a=>{n.value&&(n.value.stroke("#df4b26"),n.value.strokeWidth(3),n.value=null),l.value&&l.value.nodes([]),d.value=a},W=()=>{r.drawingLayerRef&&(r.drawingLayerRef.getNode().destroyChildren(),r.drawingLayerRef.getNode().draw(),c.value=[],n.value=null),w("clear-drawing")},E=()=>{if(c.value.length===0)return;const a=c.value.pop();a&&r.drawingLayerRef&&(a.destroy(),r.drawingLayerRef.getNode().draw()),w("undo-drawing")},P=()=>{if(!n.value||!r.drawingLayerRef)return;const a=c.value.indexOf(n.value);a!==-1&&(c.value.splice(a,1),n.value.destroy(),n.value=null),l.value&&l.value.nodes([]),r.drawingLayerRef.getNode().draw(),w("delete-selected")},B=a=>{c.value.push(a)},m=()=>{var e,t;l.value&&l.value.destroy();const a=new g.Transformer({rotateEnabled:!0,anchorSize:8,borderStroke:"#0099ff",anchorStroke:"#0099ff",anchorCornerRadius:4,boundBoxFunc:(s,i)=>i.width<10||i.height<10?s:i,ignoreStroke:!0});a.on("transformstart",()=>{y.value=!0}),a.on("transformend",()=>{var s,i;y.value=!1,(i=(s=r.drawingLayerRef)==null?void 0:s.getNode())==null||i.batchDraw()}),(t=(e=r.drawingLayerRef)==null?void 0:e.getNode())==null||t.add(a),l.value=a},L=a=>{if(!r.enableDrawing||!a||y.value)return;let e=!1;c.value.forEach(t=>{a._id==t._id&&(e=!0)}),e&&(l.value||m(),n.value!==a&&(n.value&&(n.value.stroke("#df4b26"),n.value.strokeWidth(3)),a.stroke("#3a7bd5"),a.strokeWidth(4),n.value=a,setTimeout(()=>{var t,s;if(l.value&&a)try{l.value.nodes([a]),(s=(t=r.drawingLayerRef)==null?void 0:t.getNode())==null||s.batchDraw()}catch(i){console.error("Failed to attach transformer:",i)}},0)))},z=a=>{const e=a.target.getStage();if(!r.enableDrawing||!r.drawingLayerRef||!e||y.value)return;if(d.value==="select"&&a.target!==e){L(a.target);return}if(a.target===e&&(n.value&&(n.value.stroke("#df4b26"),n.value.strokeWidth(3),n.value=null),l.value&&(l.value.nodes([]),r.drawingLayerRef.getNode().batchDraw())),n.value||d.value==="select")return;p=!0;const t=e.getPointerPosition();if(t){switch(u=t,d.value){case"free":o=new g.Line({stroke:"#df4b26",strokeWidth:3,points:[t.x,t.y],tension:0,draggable:!0,strokeScaleEnabled:!1});break;case"line":o=new g.Line({stroke:"#df4b26",strokeWidth:3,points:[t.x,t.y,t.x,t.y],draggable:!0,strokeScaleEnabled:!1});break;case"arrow":o=new g.Arrow({points:[t.x,t.y,t.x,t.y],stroke:"#df4b26",strokeWidth:3,fill:"#df4b26",pointerLength:10,pointerWidth:10,draggable:!0,strokeScaleEnabled:!1});break;case"rect":o=new g.Rect({x:t.x,y:t.y,width:0,height:0,stroke:"#df4b26",strokeWidth:3,draggable:!0,strokeScaleEnabled:!1});break;case"circle":o=new g.Circle({x:t.x,y:t.y,radius:0,stroke:"#df4b26",strokeWidth:3,draggable:!0,strokeScaleEnabled:!1});break}o.on("click tap",s=>{d.value==="select"&&L(s.currentTarget)}),r.drawingLayerRef.getNode().add(o),B(o)}},F=a=>{if(!p||!r.enableDrawing||!o)return;const e=a.target.getStage().getPointerPosition();if(e){switch(d.value){case"free":const t=o.points().concat([e.x,e.y]);o.points(t);break;case"line":o.points([u.x,u.y,e.x,e.y]);break;case"arrow":o.points([u.x,u.y,e.x,e.y]);break;case"rect":o.width(Math.abs(e.x-u.x)),o.height(Math.abs(e.y-u.y)),o.x(Math.min(u.x,e.x)),o.y(Math.min(u.y,e.y));break;case"circle":const s=e.x-u.x,i=e.y-u.y,O=Math.sqrt(s*s+i*i);o.radius(O);break}r.drawingLayerRef.getNode().batchDraw()}},V=()=>{p=!1};return H(()=>{I(()=>r.enableDrawing,a=>{var t;const e=(t=r.stageRef)==null?void 0:t.getStage();e&&(a?(e.container().style.cursor="crosshair",e.on("mousedown touchstart",z),e.on("mousemove touchmove",F),e.on("mouseup touchend mouseleave",V),G(()=>{m()})):(e.container().style.cursor="default",e.off("mousedown touchstart"),e.off("mousemove touchmove"),e.off("mouseup touchend mouseleave"),l.value&&(l.value.destroy(),l.value=null)))},{immediate:!0})}),(a,e)=>{const t=q("el-button");return k(),x("div",null,[h(t,{type:r.enableDrawing?"primary":"",onClick:M},{default:v(()=>[b(S(r.enableDrawing?"退出绘图":"自由绘图"),1)]),_:1},8,["type"]),h(t,{type:"danger",disabled:!r.enableDrawing,onClick:W},{default:v(()=>e[0]||(e[0]=[b(" 清除绘图 ")])),_:1,__:[0]},8,["disabled"]),h(t,{type:"warning",disabled:!r.enableDrawing||c.value.length===0,onClick:E},{default:v(()=>e[1]||(e[1]=[b(" 撤销 ")])),_:1,__:[1]},8,["disabled"]),r.enableDrawing?(k(),$(t,{key:0,type:"danger",disabled:!r.enableDrawing||!n.value,onClick:P},{default:v(()=>e[2]||(e[2]=[b(" 删除选中 ")])),_:1,__:[2]},8,["disabled"])):R("",!0),D.value?(k(),x("div",Q,[(k(),x(K,null,U(_,s=>h(t,{key:s.value,size:"small",type:d.value===s.value?"primary":"",onClick:i=>T(s.value)},{default:v(()=>[b(S(s.label),1)]),_:2},1032,["type","onClick"])),64))])):R("",!0)])}}}),Z=J(X,[["__scopeId","data-v-80dec199"]]);export{Z as default};
